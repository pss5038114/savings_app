<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>조립 PC 자금 플랜 — v1.1r3</title>
<link rel="manifest" href="manifest.webmanifest">
<style>
  /* ===== 테마 변수 ===== */
  :root{
    --bg:#0b0f15;--panel:#121826;--txt:#e7eefb;--muted:#9fb0c9;--acc:#7aa2ff;
    --good:#6ee7a8;--warn:#ffd166;--bad:#ff7b7b;--orange:#ffb86b;--green:#6ee7a8;--gray:#94a3b8;
    --link:#8ab4ff;--stroke:#1f2a44
  }
  [data-theme="light"]{
    --bg:#f6f8ff;--panel:#ffffff;--txt:#0b0f15;--muted:#5b6b83;--acc:#2b5eff;
    --good:#0ea371;--warn:#b88400;--bad:#d73737;--orange:#ff9c2f;--green:#0ea371;--gray:#64748b;
    --link:#1d4ed8;--stroke:#e5e7eb
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif;background:var(--bg);color:var(--txt)}
  a{color:var(--link);text-decoration:none}
  h1,h2,h3{margin:0 0 6px 0}
  .muted{color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:12px;margin:10px}
  .grid{display:grid;gap:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input,select,button,textarea{width:100%;border:1px solid var(--stroke);background:transparent;color:var(--txt);padding:10px;border-radius:10px}
  input[type="color"]{width:56px;height:34px;padding:0;border:none}
  input[type="color"]::-webkit-color-swatch{border:none}
  input[type="color"]::-webkit-color-swatch-wrapper{padding:0}
  .color-row{display:flex;gap:8px;align-items:center}
  .color-preview{flex:1;height:12px;border-radius:8px;border:1px solid var(--stroke)}
  button.primary{background:var(--acc);border:none;color:white}
  button.danger{background:#ff6b6b;border:none;color:white}
  .hide{display:none}

  /* 홈 링 */
  .dash{display:grid;grid-template-columns:1fr;gap:8px}
  .dash-title{display:flex;align-items:center;gap:6px}
  .ring-outer{display:flex;justify-content:center}
  .ring{position:relative;width:220px;height:220px}
  .ring svg{transform:rotate(-90deg);display:block}
  .ring .center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
  .ring .center #home-percent{font-size:28px;font-weight:800}

  /* 하단 네비(8개) */
  nav{position:fixed;left:0;right:0;bottom:0;height:76px;background:var(--panel);border-top:1px solid var(--stroke);display:grid;grid-template-columns:repeat(8,1fr);padding-bottom:env(safe-area-inset-bottom);z-index:6}
  [data-theme="light"] nav{background:rgba(255,255,255,.98)}
  nav button{appearance:none;background:transparent;border:none;padding:10px 6px;color:var(--muted)}
  nav button.active{color:var(--txt)}

  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .legend{display:flex;flex-direction:column;gap:6px}
  .legend-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}

  /* 자금 그래프(동적 계좌) */
  .bars{display:grid;gap:8px}
  .barrow{display:flex;justify-content:space-between;align-items:center;font-size:14px}
  .bar{height:10px;background:rgba(255,255,255,.07);border-radius:6px;overflow:hidden}
  .bar>div{height:10px}

  /* 부품 카드 */
  .p-cards{display:grid;gap:12px}
  .p-card{border:1px solid var(--stroke);border-radius:14px;padding:10px}
  .p-card .hbox{display:flex;gap:10px}
  .p-card .thumb{width:68px;height:68px;border:1px dashed var(--stroke);border-radius:10px;display:grid;place-items:center;overflow:hidden}
  .p-card .thumb img{max-width:100%;max-height:68px;display:block}
  .p-card .body{flex:1}
  .p-card .split{display:grid;grid-template-columns:1fr auto;gap:6px}
  .p-card .split-pq{grid-template-columns:3fr 1fr}
  .p-card .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
</style>
</head>
<body data-theme="dark">

<!-- ===== 상단 뷰들 ===== -->
<main style="padding-bottom:86px">
  <!-- 홈 -->
  <section id="view-home" class="card">
    <div class="dash">
      <div class="dash-title" style="font-size:18px;font-weight:700">대시보드</div>
      <div class="ring-outer">
        <div class="ring">
          <svg viewBox="0 0 220 220" preserveAspectRatio="xMidYMid meet">
            <circle cx="110" cy="110" r="88" stroke="var(--stroke)" stroke-width="14" fill="none"/>
            <circle id="seg-invest" cx="110" cy="110" r="88" stroke="#6ee7a8" stroke-width="14" stroke-linecap="round" fill="none"/>
            <circle id="seg-fixed"  cx="110" cy="110" r="88" stroke="#94a3b8" stroke-width="14" stroke-linecap="round" fill="none"/>
            <circle id="seg-float"  cx="110" cy="110" r="88" stroke="#ffb86b" stroke-width="14" stroke-linecap="round" fill="none"/>
          </svg>
          <div class="center"><div id="home-percent">0.0%</div></div>
        </div>
      </div>

      <div style="margin-top:8px">
        <div id="home-summary" style="font-size:18px;font-weight:700">-</div>
        <div class="muted" id="home-sub">-</div>
      </div>
    </div>

    <!-- 전설(구매누계, 절약, 초과, 각 계좌) -->
    <div id="home-legend" class="legend" style="margin-top:8px"></div>

    <div class="muted" id="home-extra" style="margin-top:6px"> </div>
    <div id="home-variance" class="muted" style="margin-top:6px"> </div>
  </section>

  <!-- 부품 -->
  <section id="view-parts" class="card hide">
    <div class="split">
      <h3 style="margin:0">부품</h3>
      <button id="btn-add-part">+ 부품 추가</button>
    </div>
    <div class="p-cards" id="parts-cards"></div>
  </section>

  <!-- 자금 (자금 입력 + 계좌 관리 + 이체) -->
  <section id="view-funds" class="card hide">
    <div class="split"><h3 style="margin:0">자금 관리</h3><span id="funds-balance" class="muted">-</span></div>

    <!-- 동적 계좌 그래프 + 구매누계 막대 -->
    <div id="fund-bars" class="bars"></div>

    <!-- 입금/지출 입력 -->
    <div class="row" style="margin-top:10px">
      <div>
        <label>유형</label>
        <select id="txn-kind">
          <option value="income">입금</option>
          <option value="expense">지출(구매)</option>
        </select>
      </div>
      <div>
        <label>계좌</label>
        <select id="txn-acct"></select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>금액(원)</label><input id="txn-amt" inputmode="numeric" placeholder="예: 600000" /></div>
      <div><label>메모</label><input id="txn-memo" placeholder="예: 용돈/식비 등" /></div>
    </div>
    <div class="flex" style="margin-top:12px">
      <button id="btn-add-txn" class="primary">적용</button>
    </div>
  </section>

  <!-- 계좌 관리 -->
  <section id="view-accounts-inline" class="card hide">
    <div class="split">
      <h3 style="margin:0">계좌 관리</h3>
      <button id="btn-add-acct">+ 계좌 추가</button>
    </div>
    <div id="acct-list"></div>
  </section>

  <!-- 이체 -->
  <section id="view-transfer" class="card hide">
    <div class="split"><h3 style="margin:0">이체</h3></div>
    <div class="row">
      <div><label>From</label><select id="tr-from"></select></div>
      <div><label>To</label><select id="tr-to"></select></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>금액(원)</label><input id="tr-amt" inputmode="numeric" placeholder="예: 100000"/></div>
      <div><label>메모</label><input id="tr-memo" placeholder="예: 정산/이체 등"/></div>
    </div>
    <div class="flex" style="margin-top:10px"><button id="btn-transfer" class="primary">이체 실행</button></div>
  </section>

  <!-- 캘린더 (이전 버전으로 복원) -->
  <section id="view-cal" class="card hide">
    <div class="split">
      <h3 style="margin:0">캘린더</h3>
      <div class="flex"><button id="btn-prev">◀</button><div id="cal-title" class="muted"></div><button id="btn-next">▶</button></div>
    </div>
    <div id="cal-grid" style="display:grid;margin-top:8px"></div>
    <div id="cal-detail" class="card" style="margin-top:10px"></div>
  </section>

  <!-- 메모 -->
  <section id="view-memo" class="card hide">
    <div class="split">
      <h3 style="margin:0">메모</h3>
      <div class="flex" style="gap:6px;margin-left:auto">
        <select id="memo-sort">
          <option value="desc">최신순</option>
          <option value="asc">오래된순</option>
        </select>
        <button id="btn-add-memo">+ 추가</button>
      </div>
    </div>
    <div id="memo-list" class="grid"></div>
  </section>

  <!-- 설정 -->
  <section id="view-settings" class="card hide">
    <h3 style="margin:0 0 8px 0">설정</h3>

    <div class="row">
      <div>
        <label>테마</label>
        <select id="theme-select">
          <option value="dark">다크</option>
          <option value="light">라이트</option>
        </select>
      </div>
      <div>
        <label>목표 금액 계산</label>
        <select id="target-mode">
          <option value="parts">부품 총합(기본)</option>
          <option value="manual">직접 입력</option>
        </select>
      </div>
    </div>

    <div class="row" id="manual-target-row" style="margin-top:8px;display:none">
      <div><label>목표 금액(원)</label><input id="manual-target" inputmode="numeric" placeholder="예: 8000000"/></div>
    </div>

    <div class="flex" style="justify-content:flex-end;margin-top:10px">
      <button id="btn-check-update">업데이트 확인</button>
      <button id="btn-export">백업(파일로 저장)</button>
      <button id="btn-import">복원(파일에서 불러오기)</button>
      <input type="file" id="file-import" accept="application/json" style="display:none"/>
      <button id="btn-reset" class="danger">모든 데이터 초기화</button>
    </div>
  </section>
</main>

<!-- ===== 네비게이션 ===== -->
<nav>
  <button data-view="home" class="active">홈</button>
  <button data-view="parts">부품</button>
  <button data-view="funds">자금</button>
  <button data-view="accounts-inline">계좌</button>
  <button data-view="transfer">이체</button>
  <button data-view="cal">캘린더</button>
  <button data-view="memo">메모</button>
  <button data-view="settings">설정</button>
</nav>

<script>
/* ===== 로컬 저장 ===== */
const LS_KEY = 'savings-app-v3';
const APP_SCHEMA = 3;
let state = {};
function load(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw){
    state = {schema:APP_SCHEMA, accounts:[], parts:[], txns:[], memos:[], settings:{theme:'dark',targetMode:'parts',manualTarget:0}};
    // 기본 계좌 2개
    state.accounts.push({id:uid(), name:'입출금', type:'checking', color:'#ffb86b', archived:false});
    state.accounts.push({id:uid(), name:'적금',   type:'savings',  color:'#94a3b8', archived:false});
    save();
  } else {
    state = JSON.parse(raw);
  }
  // 마이그레이션
  state.schema ??= 1; state.accounts ??= []; state.parts ??= []; state.txns ??= []; state.memos ??= [];

  // v1.1(=schema2) 올림
  if(state.schema < 2){
    const checking = {id:uid(), name:'입출금', type:'checking', color:'#ffb86b'};
    const savings  = {id:uid(), name:'적금',   type:'savings',  color:'#94a3b8'};
    state.txns.forEach(t=>{
      if(t.from==='floating') t.fromId = checking.id;
      if(t.from==='fixed')    t.fromId = savings.id;
      if(t.to==='floating')   t.toId   = checking.id;
      if(t.to==='fixed')      t.toId   = savings.id;
    });
    if(state.accounts.length===0) state.accounts=[checking,savings];
    state.schema=2;
  }
  // v1.1r1(=schema3) 올림: 색상 채움 + 기본계정 개념 제거
  if(state.schema < 3){
    state.accounts.forEach(a=>{ a.color ||= (a.type==='checking'?'#ffb86b':(a.type==='savings'?'#94a3b8':'#7aa2ff')); a.archived ??= false; });
    delete state.settings?.defaultCheckingId;
    delete state.settings?.defaultSavingsId;
    state.schema=3;
  }
}
function save(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){} }

/* ===== 도우미 ===== */
function accountById(id){ return state.accounts.find(a=>a.id===id); }

/* 이름 기반 ‘역할’ 선택(종류 제거 대응) */
function getRole(role){
  const preferredName = role==='savings' ? '적금' : '입출금';
  // 1) 이름 매칭(보관 제외) → 2) 예전 type → 3) 첫 활성 계좌
  return state.accounts.find(a=>!a.archived && a.name===preferredName)
      || state.accounts.find(a=>!a.archived && a.type===role)
      || state.accounts.find(a=>!a.archived);
}

/* 활성 전표 집합 */
function activeTxnMap(){
  const canceled = new Set();
  state.txns.forEach(t=>{ if(t.reversalOf){ canceled.add(t.id); canceled.add(t.reversalOf); }});
  const active = state.txns.filter(t=>!canceled.has(t.id));
  return {active, canceled};
}

/* 목표 합계 */
function targetTotal(){
  if(state.settings.targetMode==='manual') return num(state.settings.manualTarget);
  return state.parts.reduce((s,p)=> s + num(p.price)*num(p.qty), 0);
}

/* 집계 */
function compute(){
  const {active} = activeTxnMap();
  const balances = {}; // accountId -> amount
  let invested=0;

  active.forEach(t=>{
    if(t.kind==='income'){ if(t.toId) balances[t.toId]=(balances[t.toId]||0)+t.amount; }
    else if(t.kind==='expense'){
      if(t.fromId) balances[t.fromId]=(balances[t.fromId]||0)-t.amount;
      if(t.partId) invested += t.amount;
    }
    else if(t.kind==='transfer'){
      if(t.fromId) balances[t.fromId]=(balances[t.fromId]||0)-t.amount;
      if(t.toId)   balances[t.toId]=(balances[t.toId]||0)+t.amount;
    }
  });

  // 절약/초과: 구매된 항목만
  let saveSum=0, overSum=0;
  state.parts.forEach(p=>{
    const planned = num(p.price)*num(p.qty);
    const hasActual = p.status==='purchased' && num(p.actualPaid||p.paid)>0;
    if(!hasActual) return;
    const actual = num(p.actualPaid || p.paid);
    const v = actual - planned;
    if(v<0) saveSum += (-v);
    if(v>0) overSum += v;
  });

  const target = targetTotal();
  return {balances, invested, target, saveSum, overSum};
}

/* ===== 홈(링/전설) ===== */
function setSegment(el, r, startFrac, frac){
  const C = 2*Math.PI*r; const f = Math.max(0, Math.min(1, frac)); const s = Math.max(0, Math.min(1, startFrac));
  const seg = C * f;
  el.style.strokeDasharray = `${seg} ${C - seg}`;
  el.style.strokeDashoffset = String(C*(1 - s));
  el.style.opacity = f>0 ? 1 : 0.18;
}
function renderRing(){
  // 링은 3세그 유지(구매누계 / 적금 / 나머지 모든 계좌) — 퍼센트/요약은 전체 계좌 합계 기준
  const {balances, invested, target, saveSum, overSum} = compute();
  const activeAccts = state.accounts.filter(a=>!a.archived);
  const sav = getRole('savings');

  const totalAcc = activeAccts.reduce((s,a)=> s + (balances[a.id]||0), 0);
  const fixed = sav ? (balances[sav.id]||0) : 0;
  const others = totalAcc - fixed;

  const invF = target>0 ? invested/target : 0;
  const fixF = target>0 ? fixed/target : 0;
  const othF = target>0 ? Math.max(0, others/target) : 0;
  const totalF = Math.min(1, invF + fixF + othF);

  setSegment(byId('seg-invest'), 88, 0, invF);
  setSegment(byId('seg-fixed'),  88, invF, fixF);
  setSegment(byId('seg-float'),  88, invF+fixF, othF);
  byId('home-percent').textContent = (totalF*100).toFixed(1) + '%';

  const sumAll = totalAcc + invested;
  const extra = sumAll - target;
  byId('home-summary').textContent  = `${fmt(sumAll)} / ${fmt(target)}원`;
  const acctLine = activeAccts.map(a=> `${a.name} ${fmt(Math.max(0,balances[a.id]||0))}`).join(' · ');
  byId('home-sub').textContent = acctLine || ' ';
  byId('home-extra').textContent = extra>0 ? ('+'+fmt(extra)+'원 초과') : ' ';
  byId('home-variance').innerHTML = `절약 <span style="color:#5fb3ff;font-weight:700">+${fmt(saveSum)}</span> · 초과 <span style="color:#ff6b6b;font-weight:700">-${fmt(overSum)}</span>`;

  // 전설: 1줄=구매누계/절약/초과, 2줄=활성 계좌(요청사항)
  const leg = byId('home-legend'); leg.innerHTML='';
  const mk = (c,txt)=>{ const s=document.createElement('span'); s.className='tag'; s.innerHTML=`<span class="dot" style="background:${c}"></span><span class="muted">${txt}</span>`; return s; };
  const row1 = document.createElement('div'); row1.className='legend-row';
  row1.appendChild(mk('#6ee7a8','구매누계'));
  row1.appendChild(mk('#5fb3ff','절약'));
  row1.appendChild(mk('#ff6b6b','초과'));
  leg.appendChild(row1);
  const row2 = document.createElement('div'); row2.className='legend-row';
  activeAccts.forEach(a=> row2.appendChild(mk(a.color||'#7aa2ff', a.name)));
  leg.appendChild(row2);
}

/* ===== 부품 ===== */
function renderParts(){
  const wrap = byId('parts-cards'); wrap.innerHTML='';
  state.parts.forEach(p=>{
    const planned = num(p.price)*num(p.qty);
    const isPurchased = p.status==='purchased';
    const actual  = isPurchased ? num(p.actualPaid||p.paid||0) : 0;
    const variance = isPurchased ? (actual - planned) : 0;
    const div = document.createElement('div'); div.className='p-card'; div.dataset.id=p.id;
    div.innerHTML = `
      <div class="hbox">
        <label class="thumb">
          ${p.image?`<img src="${p.image}" alt="thumb">`:'이미지'}
          <input type="file" accept="image/*" data-act="img" style="display:none"/>
        </label>
        <div class="body">
          <input data-k="name" placeholder="부품명" value="${p.name||''}">
          <div class="split split-pq">
            <div>
              <label>가격(원)</label><input data-k="price" inputmode="numeric" value="${num(p.price)||0}">
            </div>
            <div>
              <label>수량</label><input data-k="qty" inputmode="numeric" value="${num(p.qty)||1}">
            </div>
          </div>
          <div class="split">
            <div class="muted">계획</div>
            <div class="right" style="font-weight:700">${fmt(planned)}</div>
          </div>
          <div class="split">
            <div class="muted">실지출</div>
            <div class="right" style="font-weight:700">${isPurchased?(actual?fmt(actual)+'원':'0원'):'-'}</div>
          </div>
          <div class="split">
            <div class="muted">차액</div>
            <div class="right" style="font-weight:700;${variance<0?`color:#6ee7a8`:(variance>0?`color:#ff6b6b`:``)}">${!isPurchased?'-':(variance===0?'0':(variance>0?'+':'')+fmt(variance))}</div>
          </div>
          <div class="actions">
            <button data-act="buy">${isPurchased?'되돌리기':'구매처리'}</button>
            ${isPurchased?'<button data-act="edit-actual">실지출 편집</button>':''}
            <button data-act="del" class="danger">삭제</button>
          </div>
        </div>
      </div>`;
    wrap.appendChild(div);
  });
}
function onPartsChange(e){
  const holder = e.target.closest('[data-id]'); if(!holder) return;
  const id = holder.dataset.id; const p = state.parts.find(x=>x.id===id); if(!p) return;
  const act=e.target.dataset.act, k=e.target.dataset.k;
  if(act==='img'){
    const file=e.target.files?.[0]; if(!file) return;
    const fr = new FileReader(); fr.onload = ()=>{ p.image = fr.result; save(); renderParts(); renderRing(); }; fr.readAsDataURL(file); return;
  }
  if(k){
    if(k==='name') p.name = e.target.value;
    else if(k==='price') p.price = num(e.target.value);
    else if(k==='qty') p.qty = num(e.target.value)||1;
    save(); renderParts(); renderRing();
  }
}
function onPartsClick(e){
  const holder = e.target.closest('[data-id]'); if(!holder) return;
  const id = holder.dataset.id; const p = state.parts.find(x=>x.id===id); if(!p) return;
  const act = e.target.dataset.act;

  if(act==='del'){
    if(confirm('이 부품을 삭제할까요?')){
      // 연결된 지출 전표 되돌림
      if(p.purchaseTxnIds?.length){
        p.purchaseTxnIds.forEach(id=>{
          const original = state.txns.find(t=>t.id===id); if(!original) return;
          state.txns.push({id:uid(), dt:nowLocalISO(), kind:'reversal', amount:original.amount, fromId:original.fromId, toId:original.toId, memo:'부품 삭제(자동 되돌림)', partId:original.partId, reversalOf:original.id});
        });
      }
      state.parts = state.parts.filter(x=>x.id!==p.id);
      save(); renderParts(); renderRing(); renderFunds();
    }
  }
  if(act==='edit-actual'){
    const planned = num(p.price)*num(p.qty);
    const input = prompt(`실지출 수정 (계획 ${fmt(planned)}원)`, String(num(p.actualPaid||p.paid||0)));
    if(input==null) return;
    const actual = num(input);
    p.actualPaid = actual;
    save(); renderParts(); renderRing();
  }
  if(act==='buy'){ if(p.status==='purchased') return undoPurchase(p); else return purchasePart(p); }
}
function choosePayAccounts(total){
  // 이름 기반: 적금 → 입출금 순
  const s = getRole('savings'); const c = getRole('checking');
  const {balances} = compute();
  const sBal = Math.max(0,(s && balances[s.id])||0);
  const cBal = Math.max(0,(c && balances[c.id])||0);
  const plan = [];
  let remain = total;
  if(s && sBal>0){ const use = Math.min(remain, sBal); if(use>0){ plan.push({fromId:s.id, amt:use}); remain-=use; } }
  if(remain>0 && c && cBal>0){ const use = Math.min(remain, cBal); if(use>0){ plan.push({fromId:c.id, amt:use}); remain-=use; } }
  return {plan, remain};
}
function purchasePart(p){
  const planned = num(p.price)*num(p.qty);
  let actual = planned;
  const input = prompt(`구매 금액(실지출)을 입력하세요
(계획 ${fmt(planned)}원)`, String(actual));
  if(input==null) return;
  actual = num(input); if(actual<=0) return alert('금액을 확인하세요');

  const {plan, remain} = choosePayAccounts(actual);
  if(remain>0) return alert(`보유 잔액이 부족합니다. 부족액: ${fmt(remain)}원`);

  const ids = [];
  plan.forEach(x=> ids.push(addTxn({kind:'expense', amount:x.amt, fromId:x.fromId, memo:`구매:${p.name||'부품'}`, partId:p.id})));

  p.status='purchased'; p.purchasedAt = nowLocalISO(); p.purchaseTxnIds = ids; p.paid = actual; p.actualPaid = actual;
  save(); renderAll();
}
function undoPurchase(p){
  if(!p.purchaseTxnIds?.length) return alert('연결된 전표가 없습니다.');
  if(!confirm('이 구매를 되돌릴까요?')) return;
  p.purchaseTxnIds.forEach(id=>{
    const original = state.txns.find(t=>t.id===id); if(!original) return;
    state.txns.push({id:uid(), dt:nowLocalISO(), kind:'reversal', amount:original.amount, fromId:original.fromId, toId:original.toId, memo:'구매 되돌리기', partId:original.partId, reversalOf:original.id});
  });
  p.status='planned'; p.purchaseTxnIds=[]; p.paid=0; p.actualPaid=0; p.purchasedAt=null;
  save(); renderAll();
}
function addTxn({kind, amount, fromId, toId, memo, partId}){
  const t = {id:uid(), dt:nowLocalISO(), kind, amount:num(amount), fromId:fromId||null, toId:toId||null, memo:memo||'', partId:partId||null};
  state.txns.push(t); save(); return t.id;
}

/* ===== 자금(그래프/입력) ===== */
function refreshAcctSelects(){
  const active = state.accounts.filter(a=>!a.archived);
  const opts = active.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');

  // 거래 입력
  const acctSel = byId('txn-acct');
  acctSel.innerHTML = opts;

  // 이체
  const s1 = byId('tr-from'), s2 = byId('tr-to');
  s1.innerHTML = opts; s2.innerHTML = opts;

  // 기본값: From=입출금, To=적금(없으면 임의로)
  const defFrom = active.find(a=>a.name==='입출금')?.id || active[0]?.id;
  const defTo   = active.find(a=>a.name==='적금' && a.id!==defFrom)?.id
               || active.find(a=>a.id!==defFrom)?.id
               || active[0]?.id;
  if(defFrom) s1.value = defFrom;
  if(defTo)   s2.value = defTo;
}
function renderDynamicBars(){
  const wrap = byId('fund-bars'); wrap.innerHTML='';
  const {balances, invested, target} = compute();

  // 구매누계
  const pctI  = target>0 ? Math.min(100, Math.round((invested/target)*1000)/10) : 0;
  wrap.appendChild(barRow('구매누계', '#6ee7a8', pctI));

  // 각 계좌(보관 제외)
  state.accounts.filter(a=>!a.archived).forEach(a=>{
    const bal = balances[a.id]||0;
    const pct = target>0 ? Math.min(100, Math.round((Math.max(0,bal)/target)*1000)/10) : 0;
    wrap.appendChild(barRow(a.name, a.color||'#7aa2ff', pct));
  });
}
function barRow(label,color,pct){
  const frag = document.createElement('div');
  frag.innerHTML = `
    <div class="barrow"><span>${label}</span><span>${pct}%</span></div>
    <div class="bar"><div style="width:${pct}%; background:${color}"></div></div>
  `;
  return frag;
}
function renderFunds(){
  const {balances, invested} = compute();
  const totalAcc = state.accounts.filter(a=>!a.archived).reduce((s,a)=>s+(balances[a.id]||0),0);
  byId('funds-balance').textContent = `계좌합계 ${fmt(totalAcc)} · 구매누계 ${fmt(invested)}`;
  renderDynamicBars();
}
/* 입력 적용 */
byId('btn-add-txn').onclick = ()=>{
  const kind = byId('txn-kind').value;
  const acctId = byId('txn-acct').value;
  const amt  = num(byId('txn-amt').value);
  const memo = byId('txn-memo').value;
  if(!acctId || amt<=0) return alert('입력값을 확인하세요');
  if(kind==='income') addTxn({kind:'income', amount:amt, toId:acctId, memo});
  else addTxn({kind:'expense', amount:amt, fromId:acctId, memo});
  byId('txn-amt').value=''; byId('txn-memo').value=''; renderAll();
};

/* ===== 계좌 관리 ===== */
function renderAccounts(){
  const box = byId('acct-list'); box.innerHTML='';
  state.accounts.filter(a=>!a.archived).forEach(a=>{
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="row">
        <div><label>이름</label><input data-k="name" data-id="${a.id}" value="${a.name}"></div>
        <div><label>색상(그래프)</label>
          <div class="color-row">
            <input type="color" data-k="color" data-id="${a.id}" value="${a.color||'#7aa2ff'}">
            <div class="color-preview" style="background:${a.color||'#7aa2ff'}"></div>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div style="display:flex;align-items:flex-end;justify-content:flex-end">
          <button class="danger" data-act="del" data-id="${a.id}">삭제</button>
        </div>
      </div>`;
    box.appendChild(div);
  });
  refreshAcctSelects();
}
byId('btn-add-acct').onclick = ()=>{
  state.accounts.push({id:uid(), name:'새 계좌', type:'other', color:'#7aa2ff', archived:false});
  save(); renderAccounts(); refreshAcctSelects(); renderFunds(); renderRing();
};
byId('acct-list').addEventListener('change', (e)=>{
  const id = e.target.dataset.id; if(!id) return;
  const a = accountById(id); if(!a) return;
  const k = e.target.dataset.k;
  if(k==='name') a.name = e.target.value;
  if(k==='color') a.color = e.target.value;
  save(); renderAccounts(); renderFunds(); renderRing();
});
byId('acct-list').addEventListener('click', (e)=>{
  const id = e.target.dataset.id; const act = e.target.dataset.act;
  if(act!=='del') return;
  const a = accountById(id); if(!a) return;

  const activeCount = state.accounts.filter(x=>!x.archived).length;
  if(activeCount<=2) return alert('계좌는 최소 2개 이상이어야 합니다. 다른 계좌를 먼저 추가하세요.');

  const {balances} = compute();
  const bal = Math.max(0, balances[id]||0);

  // 잔액이 있으면 어디로 옮길지 선택
  if(bal>0){
    const cands = state.accounts.filter(x=>!x.archived && x.id!==id);
    const list = cands.map((x,i)=> `${i+1}. ${x.name}`).join('\n');
    const answer = prompt(`해당 계좌 잔액 ${fmt(bal)}원을 어디로 옮길까요?\n아래 번호 중 선택해 입력하세요.\n${list}`, '1');
    if(answer==null) return;
    const idx = Math.max(1, Math.min(cands.length, parseInt(answer,10)||1)) - 1;
    const dest = cands[idx];
    addTxn({kind:'transfer', amount:bal, fromId:id, toId:dest.id, memo:'계좌 삭제 정산'});
  }

  // 실제 삭제 대신 보관 플래그
  a.archived = true;
  save(); renderAccounts(); refreshAcctSelects(); renderFunds(); renderRing();
});

/* ===== 이체 ===== */
byId('btn-transfer').onclick = ()=>{
  const fromId = byId('tr-from').value, toId = byId('tr-to').value;
  if(!fromId || !toId || fromId===toId) return alert('계좌 선택을 확인하세요.');
  const amt = num(byId('tr-amt').value); if(amt<=0) return alert('금액을 확인하세요');
  const {balances} = compute(); const bal = Math.max(0, balances[fromId]||0);
  if(amt>bal) return alert(`잔액 부족. 사용 가능: ${fmt(bal)}원`);
  addTxn({kind:'transfer', amount:amt, fromId, toId, memo: byId('tr-memo').value||'계좌 이체'});
  byId('tr-amt').value=''; byId('tr-memo').value=''; renderAll();
};

/* ===== 캘린더 (이전 로직) ===== */
let calBase = new Date(); calBase.setDate(1);
function pad2(n){ return String(n).padStart(2,'0'); }
function renderCalendar(){
  const y = calBase.getFullYear(), m = calBase.getMonth();
  byId('cal-title').textContent = `${y}-${pad2(m+1)}`;
  const grid = byId('cal-grid'); grid.innerHTML='';
  const {active} = activeTxnMap(); const target = targetTotal();
  const acts = active.slice().sort((a,b)=> a.dt.localeCompare(b.dt));
  function apply(run,t){
    if(t.kind==='income'){ if(t.toId) run.b[t.toId]=(run.b[t.toId]||0)+t.amount; }
    else if(t.kind==='expense'){ if(t.fromId) run.b[t.fromId]=(run.b[t.fromId]||0)-t.amount; if(t.partId) run.i+=t.amount; }
    else if(t.kind==='transfer'){ if(t.fromId) run.b[t.fromId]=(run.b[t.fromId]||0)-t.amount; if(t.toId) run.b[t.toId]=(run.b[t.toId]||0)+t.amount; }
  }
  // 일자별 누적 + (구매누계+계좌합계) - 목표금액 = +/-
  const days = new Date(y, m+1, 0).getDate();
  const daily = Array.from({length:days},()=>({b:{},i:0,sum:0}));
  acts.forEach(t=>{
    const d = new Date(t.dt.replace('T',' ')); if(d.getFullYear()!==y || d.getMonth()!==m) return;
    const di = d.getDate()-1;
    for(let j=di;j<days;j++){ // 그날 이후 누적
      apply(daily[j], t);
    }
  });
  for(let j=0;j<days;j++){
    const balSum = Object.values(daily[j].b).reduce((s,v)=>s+v,0);
    daily[j].sum = (balSum + daily[j].i) - target;
  }
  grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(7, 1fr)';
  const wd = new Date(y,m,1).getDay();
  for(let i=0;i<wd;i++){ const ph=document.createElement('div'); ph.className='card'; ph.style.visibility='hidden'; grid.appendChild(ph); }
  for(let d=1; d<=days; d++){
    const cell = document.createElement('div'); cell.className='card';
    const s = daily[d-1].sum;
    const color = s>0 ? '#ff6b6b' : (s<0 ? '#6ee7a8' : '#9fb0c9');
    cell.innerHTML = `<div style="font-weight:700">${d}</div><div class="muted" style="font-size:12px;color:${color}">${s>0?'+':''}${fmt(s)}</div>`;
    cell.onclick = ()=>{
      const box = byId('cal-detail'); box.innerHTML='';
      active.filter(t=>{ const dd=new Date(t.dt.replace('T',' ')); return dd.getFullYear()===y && dd.getMonth()===m && dd.getDate()===d; })
        .forEach(t=>{
          const div = document.createElement('div'); div.className='card';
          const a1 = t.fromId? (accountById(t.fromId)?.name||'') : '';
          const a2 = t.toId? (accountById(t.toId)?.name||'') : '';
          const kind = t.kind==='income'?'입금':(t.kind==='expense'?'지출':'이체');
          div.innerHTML = `
            <div class='flex' style='justify-content:space-between'>
              <div>${t.dt.replace('T',' ').slice(0,16)}</div>
              <div>${kind}</div>
            </div>
            <div class='muted'>${a1}${a1&&a2?' → ':''}${a2}</div>
            <div style='font-weight:700'>${fmt(t.amount)}</div>
            <div class='muted'>${t.memo||''}</div>`;
          box.appendChild(div);
        });
    };
    grid.appendChild(cell);
  }
}
byId('btn-prev').onclick = ()=>{ calBase.setMonth(calBase.getMonth()-1); renderCalendar(); };
byId('btn-next').onclick = ()=>{ calBase.setMonth(calBase.getMonth()+1); renderCalendar(); };

/* ===== 메모 ===== */
function renderMemo(){
  const box = byId('memo-list'); box.innerHTML='';
  const order = byId('memo-sort').value==='asc' ? 1 : -1;
  const items = [...state.memos].sort((a,b)=> order*(a.dt.localeCompare(b.dt)));
  items.forEach(m=>{
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class='flex' style='justify-content:space-between'>
        <div style='font-size:16px'>${m.text}</div><div class='muted'>${m.dt.replace('T',' ').slice(0,16)}</div>
      </div>
      <div class='flex' style='justify-content:flex-end;margin-top:8px;gap:8px'>
        <button data-id='${m.id}' data-act='edit'>수정</button>
        <button data-id='${m.id}' data-act='del' class='danger'>삭제</button>
      </div>`;
    box.appendChild(div);
  });
}
byId('btn-add-memo').onclick = ()=>{
  const t = prompt('메모 내용을 입력하세요'); if(!t) return;
  state.memos.push({id:uid(), dt:nowLocalISO(), text:t});
  save(); renderMemo();
};
byId('memo-sort').onchange = ()=> renderMemo();
byId('memo-list').addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.id; const act = btn.dataset.act;
  if(act==='del'){
    if(confirm('이 메모를 삭제할까요?')){ state.memos = state.memos.filter(m=>m.id!==id); save(); renderMemo(); }
  }
  if(act==='edit'){
    const m = state.memos.find(x=>x.id===id); if(!m) return;
    const t = prompt('메모 수정', m.text); if(t==null) return;
    m.text = t; m.dt = nowLocalISO(); save(); renderMemo();
  }
});

/* ===== 설정 ===== */
function applyTheme(){ document.body.setAttribute('data-theme', state.settings.theme || 'dark'); }
byId('theme-select').onchange = (e)=>{ state.settings.theme = e.target.value; save(); applyTheme(); };
byId('btn-check-update').onclick = async ()=>{
  try{ const reg = await navigator.serviceWorker?.getRegistration?.(); await reg?.update?.(); alert('업데이트 확인 완료! 새 버전이 있으면 잠시 후 자동 반영돼요.'); }
  catch(e){ alert('확인 실패: '+e.message); }
};
byId('btn-export').onclick = ()=>{
  try{ const raw = localStorage.getItem(LS_KEY)||'{}'; const blob = new Blob([raw],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='savings-backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),2000);
  }catch(e){ alert('백업 실패: '+e.message); }
};
byId('btn-import').onclick = ()=> byId('file-import').click();
byId('file-import').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{ const t = await f.text(); const incoming = JSON.parse(t);
    if(!confirm('현재 데이터를 덮어쓰고 복원할까요? (되돌릴 수 없어요)')) return;
    incoming.schema ??= APP_SCHEMA; incoming.accounts??=[]; incoming.parts??=[]; incoming.txns??=[]; incoming.memos??=[]; incoming.settings??={theme:'dark',targetMode:'parts',manualTarget:0};
    localStorage.setItem(LS_KEY, JSON.stringify(incoming)); state=incoming; renderAll(); alert('복원 완료!');
  }catch(err){ alert('복원 실패: '+err.message); }
  finally{ e.target.value=''; }
});
byId('btn-reset').onclick = ()=>{ if(confirm('정말로 모든 데이터를 초기화할까요?')){ localStorage.removeItem(LS_KEY); location.reload(); } };

/* ===== 네비 & 초기화 ===== */
const views = ['home','parts','funds','accounts-inline','transfer','cal','memo','settings'];
function show(v){
  views.forEach(x=>{ const el=byId('view-'+x); if(el) el.classList.toggle('hide', x!==v); });
  document.querySelectorAll('nav button').forEach(b=> b.classList.toggle('active', b.dataset.view===v));
  if(v==='home') renderRing();
  if(v==='parts') renderParts();
  if(v==='funds') { refreshAcctSelects(); renderFunds(); }
  if(v==='accounts-inline') renderAccounts();
  if(v==='cal') renderCalendar();
  if(v==='memo') renderMemo();
  if(v==='settings'){ byId('theme-select').value = state.settings.theme||'dark'; }
}
document.querySelectorAll('nav button').forEach(b=> b.onclick = ()=> show(b.dataset.view));
byId('btn-add-part').onclick = ()=>{ state.parts.push({id:uid(), name:'새 부품', image:'', price:0, qty:1, status:'planned', paid:0, actualPaid:0}); save(); renderParts(); renderRing(); };

/* 부품 카드 이벤트 바인딩 */
byId('parts-cards').addEventListener('input', onPartsChange);
byId('parts-cards').addEventListener('change', onPartsChange);
byId('parts-cards').addEventListener('click', onPartsClick);

function renderAll(){ applyTheme(); renderRing(); renderParts(); renderDynamicBars(); renderFunds(); renderAccounts(); renderCalendar(); renderMemo(); }

/* 부팅 */
try{ load(); renderAll(); console.log('App loaded'); }
catch(e){ alert('초기화 실패: '+e.message); }

/* ===== 유틸 ===== */
function byId(id){ return document.getElementById(id); }
function uid(){ return Math.random().toString(36).slice(2,10); }
function nowLocalISO(){ const d=new Date(); const t=new Date(d.getTime()-d.getTimezoneOffset()*60000); return t.toISOString().slice(0,19); }
function num(x){ x = (typeof x==='string')? x.replace(/[^0-9.-]/g,'') : x; const v=Number(x||0); return isFinite(v)?v:0; }
function fmt(n){ const s = (num(n)||0).toLocaleString('ko-KR'); return s; }
</script>
</body>
</html>
