<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì¡°ë¦½ PC ìê¸ˆ í”Œëœ â€” v1.1 (typing-stability)</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="apple-touch-icon.png" sizes="180x180">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
  /* ===== í…Œë§ˆ ë³€ìˆ˜ ===== */
  :root{
    --bg:#0b0f15;--panel:#121826;--txt:#e7eefb;--muted:#9fb0c9;--acc:#7aa2ff;
    --purchase:#6ee7a8;  /* êµ¬ë§¤ëˆ„ê³„ */
    --saving:#5fb3ff;    /* ì ˆì•½(ë°”ê¹¥ë§Â·íŒŒë‘) */
    --over:#ff6b6b;      /* ì´ˆê³¼(ë°”ê¹¥ë§Â·ë¹¨ê°•) */
    --good:#6ee7a8;      /* ìº˜ë¦°ë” ì–‘ìˆ˜/â€˜êµ¬ë§¤â€™ ë±ƒì§€ */
    --link:#8ab4ff;--stroke:#1f2a44
  }
  [data-theme="light"]{
    --bg:#f6f8ff;--panel:#ffffff;--txt:#0b0f15;--muted:#5b6b83;--acc:#2b5eff;
    --purchase:#16a34a; --saving:#2563eb; --over:#e11d48; --good:#0ea371;
    --link:#1d4ed8;--stroke:#e5e7eb
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif;background:var(--bg);color:var(--txt)}
  a{color:var(--link);text-decoration:none}

  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(18,24,38,.98),rgba(18,24,38,.85));backdrop-filter:blur(6px);padding:14px 16px;border-bottom:1px solid var(--stroke);z-index:5}
  [data-theme="light"] header{background:linear-gradient(180deg,rgba(255,255,255,.98),rgba(255,255,255,.92))}
  header h1{margin:0;font-size:16px}
  main{padding:12px 12px calc(96px + env(safe-area-inset-bottom));max-width:960px;margin:0 auto;min-height:100%}

  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:14px;margin-bottom:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row + .row{margin-top:8px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,textarea{width:100%;background:#101624;color:var(--txt);border:1px solid #263451;border-radius:12px;padding:10px 12px;outline:none;min-width:0}
  [data-theme="light"] input,[data-theme="light"] select,[data-theme="light"] textarea{background:#fff;color:#0b0f15;border-color:#d0d7e2}
  input:focus,textarea:focus,select:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(122,162,255,.16)}

  button{background:#1b2a4b;color:var(--txt);border:1px solid #2a3d66;border-radius:12px;padding:10px 12px;cursor:pointer}
  button.primary{background:#27468f;border-color:#3159b6}
  button.danger{background:#5a1f2a;border-color:#7a2b3a}
  button.ghost{background:transparent;border-color:#2a3d66;color:var(--muted)}
  [data-theme="light"] button{background:#eef2ff;border-color:#c7d2fe;color:#0b0f15}
  [data-theme="light"] button.primary{background:#2563eb;border-color:#1e40af;color:#fff}
  [data-theme="light"] button.danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
  [data-theme="light"] button.ghost{background:transparent;border-color:#cbd5e1;color:#64748b}

  .split{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:12px}
  .pill{padding:2px 8px;border:1px solid #2a3d66;border-radius:999px;font-size:12px}
  .ok{color:var(--good)} .warn{color:#ffd166} .bad{color:var(--over)}
  .dangerText{color:var(--over)}
  .hide{display:none}
  .nowrap{white-space:nowrap}
  .tag{display:inline-flex;align-items:center;gap:6px;margin-right:12px}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block}

  .ring-outer{display:flex;justify-content:center;width:100%}
  .ring{width:min(56vw,220px);height:min(56vw,220px);position:relative;display:grid;place-items:center}
  .ring svg{width:100%;height:100%;transform:rotate(-90deg);display:block}
  .ring .center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
  .ring .center #home-percent{font-size:28px;font-weight:800}

  nav{position:fixed;left:0;right:0;bottom:0;height:76px;background:rgba(18,24,38,.98);backdrop-filter:blur(6px);border-top:1px solid var(--stroke);display:grid;grid-template-columns:repeat(8,1fr);padding-bottom:env(safe-area-inset-bottom);z-index:6}
  [data-theme="light"] nav{background:rgba(255,255,255,.98)}
  nav button{appearance:none;-webkit-appearance:none;background:transparent;border:none;padding:10px 6px;color:var(--muted);outline:none;border-radius:0;-webkit-tap-highlight-color:transparent}
  nav button.active{color:var(--txt)}
  [data-theme="light"] nav button:focus,[data-theme="light"] nav button:focus-visible{outline:none}

  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .legend{display:flex;gap:6px;flex-direction:column}
  .legend-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

  .bars{display:grid;gap:8px;margin-bottom:8px}
  .bar{height:12px;background:#09111f;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
  .bar>div{height:100%}
  .barrow{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
  [data-theme="light"] .bar{background:#ffffff;border-color:#e5e7eb}

  .p-cards{display:grid;gap:10px;margin-top:14px}
  .p-card{border:1px solid var(--stroke);background:#0f1524;border-radius:14px;padding:12px}
  [data-theme="light"] .p-card{background:#fff;border-color:#e5e7eb}
  .p-card .hbox{display:grid;grid-template-columns:96px 1fr;gap:12px;align-items:start}
  .thumb{width:96px;height:96px;border-radius:12px;background:#0b1220;border:1px solid #243055;display:grid;place-items:center;color:var(--muted);overflow:hidden;cursor:pointer}
  [data-theme="light"] .thumb{background:#f5f7ff;border-color:#d0d7e2}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .p-card .head{display:flex;align-items:center;gap:8px}
  .p-card .title{flex:1}
  .p-card .meta{display:grid;grid-template-columns:3fr 1fr;gap:10px;margin-top:8px}
  .p-card .sum{margin-top:10px}
  .p-card .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}

  #cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:6px}
  .cal-cell{position:relative;padding:8px;border-radius:12px;border:1px solid var(--stroke);background:#101624;color:inherit;min-height:66px;text-align:left}
  [data-theme="light"] .cal-cell{background:#fff;border-color:#e5e7eb}
  .pct{font-feature-settings:"tnum" 1;display:inline-block;min-width:42px}
  .purchase-dot{position:absolute;right:8px;top:8px;width:6px;height:6px;border-radius:50%;background:var(--purchase)}

  #memo-sort{width:100px}

  @media (max-width: 640px){
    main{padding:10px 10px calc(96px + env(safe-area-inset-bottom))}
    .row,.row3{grid-template-columns:1fr}
    nav button{padding:10px 0;font-size:12px}
    .nowrap{white-space:normal}
    td input{font-size:14px}
  }
</style>
</head>
<body>
<header>
  <h1>ì¡°ë¦½ PC ì¥ê¸° ì €ì¶• í”Œëœ <span class="muted" id="app-version">v1.1</span></h1>
  <div class="muted">ê¼¼ê¼¼í•˜ê³  ê¾¸ì¤€íˆ ëª¨ì•„ì„œ ê¹”ë”í•˜ê³  í˜„ëª…í•˜ê²Œ ì§€ë¥¸ë‹¤!</div>
</header>

<main>
  <!-- í™ˆ -->
  <section id="view-home" class="card">
    <div class="dash">
      <div class="dash-title" style="font-size:18px;font-weight:700">ëŒ€ì‹œë³´ë“œ</div>
      <div class="ring-outer">
        <div class="ring">
          <svg id="ring-svg" viewBox="0 0 220 220" preserveAspectRatio="xMidYMid meet">
            <circle cx="110" cy="110" r="88" stroke="var(--stroke)" stroke-width="14" fill="none"/>
            <g id="seg-group"></g>
            <circle cx="110" cy="110" r="102" stroke="var(--stroke)" stroke-width="6" fill="none" opacity=".35"/>
            <g id="variance-group"></g>
          </svg>
          <div class="center"><div id="home-percent">0.0%</div></div>
        </div>
      </div>

      <div style="margin-top:8px">
        <div id="home-summary" style="font-size:18px;font-weight:700">-</div>
        <div class="muted" id="home-sub">-</div>
      </div>
    </div>

    <div id="home-legend" class="legend" style="margin-top:8px"></div>

    <div class="muted" id="home-extra" style="margin-top:6px"> </div>
    <div id="home-variance" class="muted" style="margin-top:6px"> </div>
  </section>

  <!-- ë¶€í’ˆ -->
  <section id="view-parts" class="card hide">
    <div class="split">
      <h3 style="margin:0">ë¶€í’ˆ ë¦¬ìŠ¤íŠ¸</h3>
      <div class="flex" style="gap:6px">
        <a href="https://www.compuzone.co.kr/online/online_main.htm?bannerid=GNBBannerOnlineMain" target="_blank" rel="noopener">
          <button class="ghost">ì»´í“¨ì¡´</button>
        </a>
        <button id="btn-add-part">+ ì¶”ê°€</button>
      </div>
    </div>
    <div id="parts-cards" class="p-cards"></div>
  </section>

  <!-- ìê¸ˆ -->
  <section id="view-funds" class="card hide">
    <div class="split"><h3 style="margin:0">ìê¸ˆ ê´€ë¦¬</h3><span id="funds-balance" class="muted">-</span></div>
    <div id="fund-bars" class="bars"></div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>êµ¬ë¶„</label>
        <select id="txn-kind"><option value="income">+ ì…ê¸ˆ</option><option value="expense">- ì§€ì¶œ</option></select>
      </div>
      <div>
        <label>ê³„ì¢Œ</label>
        <select id="txn-acct"></select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>ê¸ˆì•¡(ì›)</label><input id="txn-amt" inputmode="numeric" placeholder="ì˜ˆ: 600000" /></div>
      <div><label>ë©”ëª¨</label><input id="txn-memo" placeholder="ì˜ˆ: ìš©ëˆ/ì‹ë¹„ ë“±" /></div>
    </div>
    <div class="flex" style="margin-top:12px">
      <button id="btn-add-txn" class="primary">ì ìš©</button>
    </div>
  </section>

  <!-- ê³„ì¢Œ ê´€ë¦¬ -->
  <section id="view-accounts-inline" class="card hide">
    <div class="split">
      <h3 style="margin:0">ê³„ì¢Œ ê´€ë¦¬</h3>
      <button id="btn-add-acct">+ ê³„ì¢Œ ì¶”ê°€</button>
    </div>
    <div id="acct-list"></div>
  </section>

  <!-- ì´ì²´ -->
  <section id="view-transfer" class="card hide">
    <div class="split"><h3 style="margin:0">ì´ì²´</h3></div>
    <div class="row">
      <div><label>From</label><select id="tr-from"></select></div>
      <div><label>To</label><select id="tr-to"></select></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>ê¸ˆì•¡(ì›)</label><input id="tr-amt" inputmode="numeric" placeholder="ì˜ˆ: 100000"/></div>
      <div><label>ë©”ëª¨</label><input id="tr-memo" placeholder="ì˜ˆ: ê³„ì¢Œ ì´ì²´"/></div>
    </div>
    <div class="flex" style="margin-top:10px"><button id="btn-transfer" class="primary">ì´ì²´ ì‹¤í–‰</button></div>
  </section>

  <!-- ìº˜ë¦°ë” -->
  <section id="view-cal" class="card hide">
    <div class="split">
      <h3 style="margin:0">ìº˜ë¦°ë”</h3>
      <div class="flex"><button id="btn-prev">â—€</button><div id="cal-title" class="muted"></div><button id="btn-next">â–¶</button></div>
    </div>
    <div id="cal-grid" style="margin-top:8px"></div>
    <div id="cal-detail" class="card" style="margin-top:10px"></div>
  </section>

  <!-- ë©”ëª¨ -->
  <section id="view-memo" class="card hide">
    <div class="split">
      <h3 style="margin:0">ë©”ëª¨</h3>
      <div class="flex" style="gap:6px;margin-left:auto">
        <select id="memo-sort">
          <option value="desc">ìµœì‹ ìˆœ</option>
          <option value="asc">ì˜¤ë˜ëœìˆœ</option>
        </select>
        <button id="btn-add-memo">+ ì¶”ê°€</button>
      </div>
    </div>
    <div id="memo-list" class="grid"></div>
  </section>

  <!-- ì„¤ì • -->
  <section id="view-settings" class="card hide">
    <h3 style="margin:0 0 8px 0">ì„¤ì •</h3>

    <div class="card" style="margin-top:6px">
      <h4 style="margin:0 0 8px 0">ì¼ë°˜</h4>
      <div class="row">
        <div>
          <label>í…Œë§ˆ</label>
          <select id="theme-select">
            <option value="dark">ë‹¤í¬</option>
            <option value="light">ë¼ì´íŠ¸</option>
          </select>
        </div>
        <div>
          <label>ì—…ë°ì´íŠ¸</label>
          <button id="btn-check-update">ì—…ë°ì´íŠ¸ í™•ì¸</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <h4 style="margin:0 0 8px 0">ë°ì´í„°</h4>
      <div class="flex" style="gap:8px">
        <button id="btn-export">ë°±ì—…(ë‚´ë³´ë‚´ê¸°)</button>
        <button id="btn-import">ë³µì›(ê°€ì ¸ì˜¤ê¸°)</button>
        <input id="file-import" type="file" accept="application/json" style="display:none">
        <span class="muted" style="flex:1"></span>
        <button id="btn-reset" class="danger">ê°€ê³„ë¶€ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </section>
</main>

<nav>
  <button data-view="home" class="active">í™ˆ</button>
  <button data-view="parts">ë¶€í’ˆ</button>
  <button data-view="funds">ìê¸ˆ</button>
  <button data-view="accounts-inline">ê³„ì¢Œ</button>
  <button data-view="transfer">ì´ì²´</button>
  <button data-view="cal">ìº˜ë¦°ë”</button>
  <button data-view="memo">ë©”ëª¨</button>
  <button data-view="settings">ì„¤ì •</button>
</nav>

<script>
/* ===== ìœ í‹¸/ìƒìˆ˜ ===== */
const fmt = n => (Number(n||0)).toLocaleString('ko-KR');
const num = s => Math.max(0, Math.floor(Number(String(s||'').replace(/[^0-9.-]/g,''))||0));
const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : 'id_'+Math.random().toString(36).slice(2));
const pad2 = n => String(n).padStart(2,'0');
const todayLocal = () => { const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
const nowLocalISO = () => { const d=new Date(); const off=-d.getTimezoneOffset(); const sign=off>=0?'+':'-'; const hh=pad2(Math.floor(Math.abs(off)/60)); const mm=pad2(Math.abs(off)%60); const ts=`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`; return ts+sign+hh+":"+mm; };
const byId = id => document.getElementById(id);

const LS_KEY = 'pc-goal-mvp-v7';
const APP_SCHEMA = 3;

/* ===== ìƒíƒœ ===== */
let state = {
  schema: APP_SCHEMA,
  settings: { targetMode:'parts', manualTarget:0, theme:'dark' },
  accounts: [],
  parts: [],
  txns: [],
  memos: []
};

/* ===== ë¡œë“œ & ë§ˆì´ê·¸ ===== */
function load(){
  try{ const raw = localStorage.getItem(LS_KEY); if(raw) state = JSON.parse(raw); }catch(e){}

  state.schema ??= 1;
  state.settings ??= {theme:'dark', targetMode:'parts', manualTarget:0};
  state.accounts ??= []; state.parts ??= []; state.txns ??= []; state.memos ??= [];

  if(state.schema < 2){
    const checking = {id:uid(), name:'ì…ì¶œê¸ˆ', type:'checking', color:'#ffb86b'};
    const savings  = {id:uid(), name:'ì ê¸ˆ',   type:'savings',  color:'#94a3b8'};
    state.txns.forEach(t=>{
      if(t.from==='floating') t.fromId = checking.id;
      if(t.from==='fixed')    t.fromId = savings.id;
      if(t.to==='floating')   t.toId   = checking.id;
      if(t.to==='fixed')      t.toId   = savings.id;
    });
    if(state.accounts.length===0) state.accounts=[checking,savings];
    state.schema=2;
  }
  if(state.schema < 3){
    state.accounts.forEach(a=>{
      if(!a.color){
        a.color = a.type==='savings' ? '#94a3b8'
               : a.type==='checking'? '#ffb86b'
               : '#7aa2ff';
      }
      a.archived ??= false;
    });
    delete state.settings.defaultCheckingId;
    delete state.settings.defaultSavingsId;
    state.schema=3;
  }
}
function save(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){} }

function accountById(id){ return state.accounts.find(a=>a.id===id); }
function getRole(role){
  const preferredName = role==='savings' ? 'ì ê¸ˆ' : 'ì…ì¶œê¸ˆ';
  return state.accounts.find(a=>!a.archived && a.name===preferredName)
      || state.accounts.find(a=>!a.archived && a.type===role)
      || state.accounts.find(a=>!a.archived);
}
function activeTxnMap(){
  const canceled = new Set();
  state.txns.forEach(t=>{ if(t.reversalOf){ canceled.add(t.id); canceled.add(t.reversalOf); }});
  const active = state.txns.filter(t=>!canceled.has(t.id));
  return {active, canceled};
}
function targetTotal(){
  if(state.settings.targetMode==='manual') return num(state.settings.manualTarget);
  return state.parts.reduce((s,p)=> s + num(p.price)*num(p.qty), 0);
}

/* í•µì‹¬ ê³„ì‚° */
function compute(){
  const {active} = activeTxnMap();
  const balances = {};
  let invested=0;

  active.forEach(t=>{
    if(t.kind==='income'){ if(t.toId) balances[t.toId]=(balances[t.toId]||0)+t.amount; }
    else if(t.kind==='expense'){
      if(t.fromId) balances[t.fromId]=(balances[t.fromId]||0)-t.amount;
      if(t.partId) invested += t.amount;
    }
    else if(t.kind==='transfer'){
      if(t.fromId) balances[t.fromId]=(balances[t.fromId]||0)-t.amount;
      if(t.toId)   balances[t.toId]=(balances[t.toId]||0)+t.amount;
    }
  });

  let saveSum=0, overSum=0;
  state.parts.forEach(p=>{
    const planned = num(p.price)*num(p.qty);
    const hasActual = p.status==='purchased' && num(p.actualPaid||p.paid)>0;
    if(!hasActual) return;
    const actual = num(p.actualPaid || p.paid);
    const diff = planned - actual; // +ë©´ ì ˆì•½, -ë©´ ì´ˆê³¼
    if(diff>0) saveSum += diff;
    if(diff<0) overSum += -diff;
  });

  const target = targetTotal();
  return {balances, invested, target, saveSum, overSum};
}

/* ===== í™ˆ(ë§/ì „ì„¤) ===== */
function setSegment(el, r, startFrac, frac){
  const C = 2*Math.PI*r; const f = Math.max(0, Math.min(1, frac)); const s = Math.max(0, Math.min(1, startFrac));
  const seg = C * f;
  el.style.strokeDasharray = `${seg} ${C - seg}`;
  el.style.strokeDashoffset = String(C*(1 - s));
  el.style.opacity = f>0 ? 1 : 0.18;
}
function renderRing(){
  const {balances, invested, target, saveSum, overSum} = compute();
  const activeAccts = state.accounts.filter(a=>!a.archived);
  const sumAcc = activeAccts.reduce((s,a)=> s + Math.max(0,(balances[a.id]||0)), 0);

  const netAdj = saveSum - overSum;
  const totalF = target>0 ? Math.max(0, Math.min(1, (invested + sumAcc + netAdj)/target )) : 0;
  byId('home-percent').textContent = (totalF*100).toFixed(1) + '%';

  const g = document.getElementById('seg-group');
  while(g.firstChild) g.removeChild(g.firstChild);

  let start = 0;
  const r = 88;
  const svgNS = 'http://www.w3.org/2000/svg';

  const invF = target>0 ? Math.max(0, Math.min(1, invested/target)) : 0;
  const c1 = document.createElementNS(svgNS, 'circle');
  c1.setAttribute('cx','110'); c1.setAttribute('cy','110'); c1.setAttribute('r', String(r));
  c1.setAttribute('stroke', 'var(--purchase)'); c1.setAttribute('stroke-width','14'); c1.setAttribute('stroke-linecap','round'); c1.setAttribute('fill','none');
  g.appendChild(c1);
  setSegment(c1, r, start, invF);
  start += invF;

  activeAccts.forEach(a=>{
    const frac = target>0 ? Math.max(0, (balances[a.id]||0)/target) : 0;
    if(frac<=0) return;
    const cc = document.createElementNS(svgNS, 'circle');
    cc.setAttribute('cx','110'); cc.setAttribute('cy','110'); cc.setAttribute('r', String(r));
    cc.setAttribute('stroke', a.color || '#7aa2ff'); cc.setAttribute('stroke-width','14'); cc.setAttribute('stroke-linecap','round'); cc.setAttribute('fill','none');
    g.appendChild(cc);
    setSegment(cc, r, start, frac);
    start += frac;
  });

  const vg = document.getElementById('variance-group');
  while(vg.firstChild) vg.removeChild(vg.firstChild);

  const r2 = 102;
  const saveFrac = target>0 ? Math.max(0, Math.min(1, saveSum/target)) : 0;
  const overFrac = target>0 ? Math.max(0, Math.min(1, overSum/target)) : 0;

  if(saveFrac>0){
    const cs = document.createElementNS(svgNS, 'circle');
    cs.setAttribute('cx','110'); cs.setAttribute('cy','110'); cs.setAttribute('r', String(r2));
    cs.setAttribute('stroke','var(--saving)'); cs.setAttribute('stroke-width','6'); cs.setAttribute('stroke-linecap','round'); cs.setAttribute('fill','none');
    vg.appendChild(cs);
    setSegment(cs, r2, 1 - saveFrac, saveFrac);
  }
  if(overFrac>0){
    const co = document.createElementNS(svgNS, 'circle');
    co.setAttribute('cx','110'); co.setAttribute('cy','110'); co.setAttribute('r', String(r2));
    co.setAttribute('stroke','var(--over)'); co.setAttribute('stroke-width','6'); co.setAttribute('stroke-linecap','round'); co.setAttribute('fill','none');
    vg.appendChild(co);
    setSegment(co, r2, 0, overFrac);
  }

  const targetSum = target;
  const sumAll = invested + sumAcc + (saveSum - overSum);
  const extra = sumAll - targetSum;
  byId('home-summary').textContent  = `${fmt(sumAll)} / ${fmt(targetSum)}ì›`;

  const acctLine = activeAccts.map(a=>{
    const pct = target>0 ? (Math.max(0, balances[a.id]||0) / target * 100) : 0;
    return `${a.name} ${pct.toFixed(1)}%`;
  }).join(' Â· ');
  byId('home-sub').textContent = acctLine || ' ';

  byId('home-extra').textContent = extra>0 ? ('+'+fmt(extra)+'ì› ì´ˆê³¼') : (extra<0 ? (fmt(extra)+'ì› ë¯¸ë‹¬') : ' ');

  byId('home-variance').innerHTML =
    `ë°”ê¹¥ ë§ â€” <span style="color:var(--saving);font-weight:700">ì ˆì•½ ${fmt(saveSum)}</span> Â· <span style="color:var(--over);font-weight:700">ì´ˆê³¼ ${fmt(overSum)}</span> (ì¤‘ì•™ %ì— Â±ë°˜ì˜)`;

  const leg = byId('home-legend'); leg.innerHTML='';
  const mk = (c,txt)=>{ const s=document.createElement('span'); s.className='tag'; s.innerHTML=`<span class="dot" style="background:${c}"></span><span class="muted">${txt}</span>`; return s; };
  const row1 = document.createElement('div'); row1.className='legend-row';
  row1.appendChild(mk('var(--purchase)','êµ¬ë§¤ëˆ„ê³„'));
  row1.appendChild(mk('var(--saving)','ì ˆì•½(ë°”ê¹¥ë§)'));
  row1.appendChild(mk('var(--over)','ì´ˆê³¼(ë°”ê¹¥ë§)'));
  leg.appendChild(row1);
  const row2 = document.createElement('div'); row2.className='legend-row';
  activeAccts.forEach(a=> row2.appendChild(mk(a.color||'#7aa2ff', a.name)));
  leg.appendChild(row2);
}

/* ===== ë¶€í’ˆ ===== */
function renderParts(){
  const wrap = byId('parts-cards'); wrap.innerHTML='';
  state.parts.forEach(p=>{
    const planned = num(p.price)*num(p.qty);
    const isPurchased = p.status==='purchased';
    const actual  = isPurchased ? num(p.actualPaid||p.paid||0) : 0;
    const variance = isPurchased ? (actual - planned) : 0;
    const div = document.createElement('div'); div.className='p-card'; div.dataset.id=p.id;
    div.innerHTML = `
      <div class="hbox">
        <label class="thumb">
          ${p.image?`<img src="${p.image}" alt="thumb">`:'ì´ë¯¸ì§€'}
          <input type="file" accept="image/*" data-act="img" style="display:none">
        </label>
        <div>
          <div class="head">
            <input class="title" data-k="name" placeholder="ì œí’ˆëª…" value="${p.name||''}">
            ${isPurchased?'<span class="pill ok">êµ¬ë§¤</span>':'<span class="pill">ëŒ€ê¸°</span>'}
          </div>
          <div class="meta">
            <div><label>ê°€ê²©(ê³„íš)</label><input data-k="price" inputmode="numeric" value="${p.price||0}"></div>
            <div><label>ìˆ˜ëŸ‰</label><input data-k="qty" inputmode="numeric" value="${p.qty||1}"></div>
          </div>
          <div class="split sum">
            <div class="muted">í•©ê³„(ê³„íš)</div>
            <div class="right" data-role="sum" style="font-weight:700">${fmt(planned)}ì›</div>
          </div>
          <div class="split">
            <div class="muted">ì‹¤ì§€ì¶œ</div>
            <div class="right" style="font-weight:700">${isPurchased?(actual?fmt(actual)+'ì›':'0ì›'):'-'}</div>
          </div>
          <div class="split">
            <div class="muted">ì°¨ì•¡</div>
            <div class="right" style="font-weight:700;${variance<0?'color:var(--saving)':variance>0?'color:var(--over)':''}">${!isPurchased?'-':(variance===0?'0':(variance>0?'+':'')+fmt(variance))}</div>
          </div>
          <div class="actions">
            <button data-act="buy">${isPurchased?'ë˜ëŒë¦¬ê¸°':'êµ¬ë§¤ì²˜ë¦¬'}</button>
            ${isPurchased?'<button data-act="edit-actual">ì‹¤ì§€ì¶œ í¸ì§‘</button>':''}
            <button data-act="del" class="danger">ì‚­ì œ</button>
          </div>
        </div>
      </div>`;
    wrap.appendChild(div);
  });
}

/* ë¶€ë¶„ ì—…ë°ì´íŠ¸ìš© í—¬í¼ */
function updatePartCardSum(holder, p){
  const sumEl = holder.querySelector('[data-role="sum"]');
  if(sumEl) sumEl.textContent = fmt(num(p.price)*num(p.qty))+'ì›';
}

/* ì‹¤ì§€ì¶œ í¸ì§‘ ì‹œ ì „í‘œ ê¸ˆì•¡ ë™ê¸°í™” */
function adjustPurchaseTxns(p, newTotal){
  if(!Array.isArray(p.purchaseTxnIds) || p.purchaseTxnIds.length===0) return;
  const txs = p.purchaseTxnIds
    .map(id => state.txns.find(t => t.id===id && t.kind==='expense' && !t.reversalOf))
    .filter(Boolean);
  if(txs.length===0) return;
  const current = txs.reduce((s,t)=> s + (t.amount||0), 0);
  let diff = newTotal - current;
  if(diff === 0) return;

  if(diff > 0){
    txs[txs.length-1].amount += diff;
  }else{
    let need = -diff;
    for(let i=txs.length-1; i>=0 && need>0; i--){
      const cut = Math.min(need, txs[i].amount);
      txs[i].amount -= cut;
      need -= cut;
    }
    p.purchaseTxnIds = p.purchaseTxnIds.filter(id=>{
      const t = state.txns.find(x=>x.id===id);
      return t && t.amount>0;
    });
    state.txns = state.txns.filter(t => t.amount>0);
  }
}

/* ğŸ”§ ì—¬ê¸° ìˆ˜ì •: input(íƒ€ì´í•‘ ì¤‘)ì—ì„œëŠ” ì¬ë Œë” X â€” í¬ì»¤ìŠ¤ ìœ ì§€ */
function onPartsChange(e){
  const holder = e.target.closest('[data-id]'); if(!holder) return;
  const id = holder.dataset.id; const p = state.parts.find(x=>x.id===id); if(!p) return;
  const act = e.target.dataset.act; const k = e.target.dataset.k;

  if(act==='img'){
    const file = e.target.files?.[0]; if(!file) return;
    const fr = new FileReader(); fr.onload = ()=>{ p.image = fr.result; save(); renderParts(); renderRing(); }; fr.readAsDataURL(file); return;
  }

  if(!k) return;

  if(k==='name') p.name = e.target.value;
  else if(k==='price') p.price = num(e.target.value);
  else if(k==='qty') p.qty = num(e.target.value)||1;

  save();

  if(e.type === 'input'){
    updatePartCardSum(holder, p);  // ì¹´ë“œ ì•ˆ í•©ê³„ë§Œ ê°±ì‹ 
    renderRing();                  // ëª©í‘œ í•©ê³„ ë°˜ì˜(ì¬ê³„ì‚°)
  } else {
    renderParts();                 // blur/change ì‹œ ì „ì²´ ìƒˆë¡œê³ ì¹¨
    renderRing();
  }
}

function onPartsClick(e){
  const holder = e.target.closest('[data-id]'); if(!holder) return;
  const id = holder.dataset.id; const p = state.parts.find(x=>x.id===id); if(!p) return;
  const act = e.target.dataset.act;

  if(act==='del'){
    if(confirm('ì´ ë¶€í’ˆì„ ì‚­ì œí• ê¹Œìš”?')){
      state.parts = state.parts.filter(x=>x.id!==id);
      save(); renderParts(); renderRing(); renderCalendar();
    }
  }
  if(act==='edit-actual'){
    const planned = num(p.price)*num(p.qty);
    const input = prompt(`ì‹¤ì§€ì¶œ ìˆ˜ì • (ê³„íš ${fmt(planned)}ì›)`, String(num(p.actualPaid||p.paid||0)));
    if(input==null) return;
    const actual = num(input);
    adjustPurchaseTxns(p, actual);
    p.actualPaid = actual;
    save(); renderParts(); renderRing(); renderCalendar();
  }
  if(act==='buy'){ if(p.status==='purchased') return undoPurchase(p); else return purchasePart(p); }
}

function choosePayAccounts(total){
  const s = getRole('savings'); const c = getRole('checking');
  const {balances} = compute();
  const sBal = Math.max(0,(s && balances[s.id])||0);
  const cBal = Math.max(0,(c && balances[c.id])||0);
  const plan = [];
  let remain = total;
  if(s && sBal>0){ const use = Math.min(remain, sBal); if(use>0){ plan.push({fromId:s.id, amt:use}); remain-=use; } }
  if(remain>0 && c && cBal>0){ const use = Math.min(remain, cBal); if(use>0){ plan.push({fromId:c.id, amt:use}); remain-=use; } }
  return {plan, remain};
}
function purchasePart(p){
  const planned = num(p.price)*num(p.qty);
  let actual = planned;
  const input = prompt(`êµ¬ë§¤ ê¸ˆì•¡(ì‹¤ì§€ì¶œ)ì„ ì…ë ¥í•˜ì„¸ìš”\n(ê³„íš ${fmt(planned)}ì›)`, String(actual));
  if(input==null) return;
  actual = num(input); if(actual<=0) return alert('ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”');

  const {plan, remain} = choosePayAccounts(actual);
  if(remain>0) return alert(`ë³´ìœ  ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë¶€ì¡±ì•¡: ${fmt(remain)}ì›`);

  const ids = [];
  plan.forEach(x=> ids.push(addTxn({kind:'expense', amount:x.amt, fromId:x.fromId, memo:`êµ¬ë§¤:${p.name||'ë¶€í’ˆ'}`, partId:p.id})));

  p.status='purchased'; p.purchasedAt = nowLocalISO(); p.purchaseTxnIds = ids; p.paid = actual; p.actualPaid = actual;
  save(); renderAll();
}
function undoPurchase(p){
  if(!p.purchaseTxnIds?.length) return alert('ì—°ê²°ëœ ì „í‘œê°€ ì—†ìŠµë‹ˆë‹¤.');
  if(!confirm('ì´ êµ¬ë§¤ë¥¼ ë˜ëŒë¦´ê¹Œìš”?')) return;
  p.purchaseTxnIds.forEach(id=>{
    const original = state.txns.find(t=>t.id===id); if(!original) return;
    state.txns.push({id:uid(), dt:nowLocalISO(), kind:'reversal', amount:original.amount, fromId:original.fromId, toId:original.toId, memo:'êµ¬ë§¤ ë˜ëŒë¦¬ê¸°', partId:original.partId, reversalOf:original.id});
  });
  p.status='planned'; p.purchaseTxnIds=[]; p.paid=0; p.actualPaid=0; p.purchasedAt=null;
  save(); renderAll();
}
function addTxn({kind, amount, fromId, toId, memo, partId}){
  const t = {id:uid(), dt:nowLocalISO(), kind, amount:num(amount), fromId:fromId||null, toId:toId||null, memo:memo||'', partId:partId||null};
  state.txns.push(t); save(); return t.id;
}

/* ===== ìê¸ˆ ===== */
function refreshAcctSelects(){
  const active = state.accounts.filter(a=>!a.archived);
  const opts = active.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');

  const acctSel = byId('txn-acct'); acctSel.innerHTML = opts;
  const s1 = byId('tr-from'), s2 = byId('tr-to');
  s1.innerHTML = opts; s2.innerHTML = opts;

  const defFrom = active.find(a=>a.name==='ì…ì¶œê¸ˆ')?.id || active[0]?.id;
  const defTo   = active.find(a=>a.name==='ì ê¸ˆ' && a.id!==defFrom)?.id
               || active.find(a=>a.id!==defFrom)?.id
               || active[0]?.id;
  if(defFrom) s1.value = defFrom;
  if(defTo)   s2.value = defTo;
}
function renderDynamicBars(){
  const wrap = byId('fund-bars'); wrap.innerHTML='';
  const {balances, invested, target} = compute();

  const pctI  = target>0 ? Math.min(100, Math.round((invested/target)*1000)/10) : 0;
  wrap.appendChild(barRow('êµ¬ë§¤ëˆ„ê³„', 'var(--purchase)', pctI));

  state.accounts.filter(a=>!a.archived).forEach(a=>{
    const bal = balances[a.id]||0;
    const pct = target>0 ? Math.min(100, Math.round((Math.max(0,bal)/target)*1000)/10) : 0;
    wrap.appendChild(barRow(a.name, a.color||'#7aa2ff', pct));
  });
}
function barRow(label,color,pct){
  const frag = document.createElement('div');
  frag.innerHTML = `
    <div class="barrow"><span>${label}</span><span>${pct}%</span></div>
    <div class="bar"><div style="width:${pct}%; background:${color}"></div></div>
  `;
  return frag;
}
function renderFunds(){
  const {balances, invested} = compute();
  const totalAcc = state.accounts.filter(a=>!a.archived).reduce((s,a)=>s+(balances[a.id]||0),0);
  byId('funds-balance').textContent = `ê³„ì¢Œí•©ê³„ ${fmt(totalAcc)} Â· êµ¬ë§¤ëˆ„ê³„ ${fmt(invested)}`;
  renderDynamicBars();
}
byId('btn-add-txn').onclick = ()=>{
  const kind = byId('txn-kind').value;
  const acctId = byId('txn-acct').value;
  const amt  = num(byId('txn-amt').value);
  const memo = byId('txn-memo').value;
  if(amt<=0) return alert('ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”');

  const {balances} = compute();
  if(kind==='expense'){
    const bal = Math.max(0, balances[acctId]||0);
    if(amt>bal) return alert(`í•´ë‹¹ ê³„ì¢Œ ì”ì•¡ë³´ë‹¤ í° ì§€ì¶œì€ ë¶ˆê°€í•©ë‹ˆë‹¤.\nì”ì•¡: ${fmt(bal)}ì›`);
    addTxn({kind:'expense', amount:amt, fromId:acctId, memo});
  } else {
    addTxn({kind:'income', amount:amt, toId:acctId, memo});
  }
  byId('txn-amt').value=''; byId('txn-memo').value=''; renderAll();
};

/* ===== ê³„ì¢Œ ê´€ë¦¬ ===== */
function renderAccounts(){
  const box = byId('acct-list'); box.innerHTML='';
  state.accounts.filter(a=>!a.archived).forEach(a=>{
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="row">
        <div><label>ì´ë¦„</label><input data-k="name" data-id="${a.id}" value="${a.name}"></div>
        <div>
          <label>ìƒ‰ìƒ(ê·¸ë˜í”„)</label>
          <div style="height:10px;border:1px solid var(--stroke);border-radius:999px;overflow:hidden;margin-top:8px">
            <div data-role="colorbar" data-id="${a.id}" style="height:100%;width:100%;background:${a.color||'#7aa2ff'}"></div>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div style="display:flex;align-items:center;justify-content:flex-end;gap:8px">
          <input class="hide" type="color" data-k="color" data-id="${a.id}" value="${a.color||'#7aa2ff'}">
          <button data-act="pick" data-id="${a.id}">ìƒ‰ìƒ ì§€ì •</button>
          <button class="danger" data-act="del" data-id="${a.id}">ì‚­ì œ</button>
        </div>
      </div>`;
    box.appendChild(div);
  });
  refreshAcctSelects();
}
byId('acct-list').addEventListener('change', (e)=>{
  const id = e.target.dataset.id; if(!id) return;
  const a = accountById(id); if(!a) return;
  const k = e.target.dataset.k;
  if(k==='name') a.name = e.target.value;
  if(k==='color'){ a.color = e.target.value; }
  save(); renderAccounts(); renderFunds(); renderRing();
});
byId('acct-list').addEventListener('click', (e)=>{
  const id = e.target.dataset.id; const act = e.target.dataset.act;
  if(!id || !act) return;

  if(act==='pick'){
    const holder = e.target.closest('.card');
    const picker = holder.querySelector(`input[type="color"][data-id="${id}"]`);
    picker?.click();
    return;
  }

  if(act==='del'){
    const a = accountById(id); if(!a) return;

    const activeCount = state.accounts.filter(x=>!x.archived).length;
    if(activeCount<=2) return alert('ê³„ì¢ŒëŠ” ìµœì†Œ 2ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ê³„ì¢Œë¥¼ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”.');

    const {balances} = compute();
    const bal = Math.max(0, balances[id]||0);

    if(bal>0){
      const cands = state.accounts.filter(x=>!x.archived && x.id!==id);
      const list = cands.map((x,i)=> `${i+1}. ${x.name}`).join('\n');
      const answer = prompt(`í•´ë‹¹ ê³„ì¢Œ ì”ì•¡ ${fmt(bal)}ì›ì„ ì–´ë””ë¡œ ì˜®ê¸¸ê¹Œìš”?\nì•„ë˜ ë²ˆí˜¸ ì¤‘ ì„ íƒí•´ ì…ë ¥í•˜ì„¸ìš”.\n${list}`, '1');
      if(answer==null) return;
      const idx = Math.max(1, Math.min(cands.length, parseInt(answer,10)||1)) - 1;
      const dest = cands[idx];
      addTxn({kind:'transfer', amount:bal, fromId:id, toId:dest.id, memo:'ê³„ì¢Œ ì‚­ì œ ì •ì‚°'});
    }

    const a2 = accountById(id); if(!a2) return;
    a2.archived = true;
    save(); renderAccounts(); refreshAcctSelects(); renderFunds(); renderRing();
  }
});
byId('btn-add-acct').onclick = ()=>{
  state.accounts.push({id:uid(), name:'ìƒˆ ê³„ì¢Œ', type:'other', color:'#7aa2ff', archived:false});
  save(); renderAccounts(); refreshAcctSelects(); renderFunds(); renderRing();
};

/* ===== ì´ì²´ ===== */
byId('btn-transfer').onclick = ()=>{
  const fromId = byId('tr-from').value, toId = byId('tr-to').value;
  if(!fromId || !toId || fromId===toId) return alert('ê³„ì¢Œ ì„ íƒì„ í™•ì¸í•˜ì„¸ìš”.');
  const amt = num(byId('tr-amt').value); if(amt<=0) return alert('ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”');
  const {balances} = compute(); const bal = Math.max(0, balances[fromId]||0);
  if(amt>bal) return alert(`ì”ì•¡ ë¶€ì¡±. ì‚¬ìš© ê°€ëŠ¥: ${fmt(bal)}ì›`);
  addTxn({kind:'transfer', amount:amt, fromId, toId, memo: byId('tr-memo').value||'ê³„ì¢Œ ì´ì²´'});
  byId('tr-amt').value=''; byId('tr-memo').value=''; renderAll();
};

/* ===== ìº˜ë¦°ë” ===== */
let calBase = new Date(); calBase.setDate(1);
function varianceBefore(monthPrefix){
  let v=0;
  state.parts.forEach(p=>{
    if(p.status!=='purchased' || !p.purchasedAt) return;
    if(p.purchasedAt.slice(0,7) < monthPrefix){
      const planned = num(p.price)*num(p.qty);
      const actual  = num(p.actualPaid||p.paid);
      v += (planned - actual);
    }
  });
  return v;
}
function varianceOn(date){
  let v=0;
  state.parts.forEach(p=>{
    if(p.status!=='purchased' || !p.purchasedAt) return;
    if(p.purchasedAt.slice(0,10)===date){
      const planned = num(p.price)*num(p.qty);
      const actual  = num(p.actualPaid||p.paid);
      v += (planned - actual);
    }
  });
  return v;
}
function renderCalendar(){
  const y = calBase.getFullYear(), m = calBase.getMonth();
  byId('cal-title').textContent = `${y}-${pad2(m+1)}`;
  const grid = byId('cal-grid'); grid.innerHTML='';
  const {active} = activeTxnMap(); const target = targetTotal();
  const acts = active.slice().sort((a,b)=> a.dt.localeCompare(b.dt));
  function apply(run,t){
    if(t.kind==='income'){ if(t.toId) run.b[t.toId]=(run.b[t.toId]||0)+t.amount; }
    else if(t.kind==='expense'){ if(t.fromId) run.b[t.fromId]=(run.b[t.fromId]||0)-t.amount; if(t.partId) run.i+=t.amount; }
    else if(t.kind==='transfer'){ if(t.fromId){run.b[t.fromId]=(run.b[t.fromId]||0)-t.amount;} if(t.toId){run.b[t.toId]=(run.b[t.toId]||0)+t.amount;} }
  }
  let run = {b:{},i:0,v:0}; const monthPrefix = `${y}-${pad2(m+1)}`;

  acts.forEach(t=>{ if(t.dt.slice(0,7) < monthPrefix) apply(run,t); });
  run.v = varianceBefore(monthPrefix);

  let prevProg = target>0 ? ((Object.values(run.b).reduce((s,v)=>s+v,0))+run.i+run.v)/target : 0;
  const byDate = {}; acts.forEach(t=>{ if(t.dt.slice(0,7)===monthPrefix){ (byDate[t.dt.slice(0,10)] ??= []).push(t);} });
  const firstDay = new Date(y,m,1);
  for(let i=0;i<firstDay.getDay();i++){ const c=document.createElement('div'); grid.appendChild(c); }
  const days = new Date(y,m+1,0).getDate();
  for(let day=1; day<=days; day++){
    const dstr = `${y}-${pad2(m+1)}-${pad2(day)}`;
    (byDate[dstr]||[]).forEach(t=> apply(run,t));
    run.v += varianceOn(dstr);

    const endProg = target>0 ? ((Object.values(run.b).reduce((s,v)=>s+v,0))+run.i+run.v)/target : 0;
    const delta = Math.round((endProg - prevProg)*1000)/10; prevProg = endProg;

    const bought = (byDate[dstr]||[]).some(t=> t.kind==='expense' && !!t.partId)
                || state.parts.some(p=> p.status==='purchased' && p.purchasedAt?.slice(0,10)===dstr);

    const cell = document.createElement('button'); cell.className='cal-cell';
    const color = delta>0? 'ok' : delta<0? 'dangerText' : 'muted';
    cell.innerHTML = `
      <div style='font-weight:700'>${day}</div>
      <div class='${color} pct' style='font-size:12px'>${delta>0?'+':''}${delta.toFixed(1)}%</div>
      ${bought ? '<span class="purchase-dot" title="êµ¬ë§¤ ìˆìŒ"></span>' : ''}
    `;
    cell.onclick = ()=> openDayDetail(dstr); grid.appendChild(cell);
  }
  byId('cal-detail').innerHTML = '<span class="muted">ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤.</span>';
}
function openDayDetail(date){
  const {active} = activeTxnMap(); const list = active.filter(t=> t.dt.slice(0,10)===date); const box = byId('cal-detail');
  if(list.length===0){ box.innerHTML = `<div class='muted'>${date} ë‚´ì—­ ì—†ìŒ</div>`; return; }
  let html = `<div style='font-weight:700;margin-bottom:8px'>${date}</div>`;
  list.forEach(t=>{
    const from = t.fromId? (accountById(t.fromId)?.name||'') : '';
    const to   = t.toId?   (accountById(t.toId)?.name||'')   : '';
    const sign = t.kind==='income' ? '+' : t.kind==='expense' ? '-' : '';
    const acctStr = t.kind==='transfer' ? `${from} â†’ ${to}` : (from||to||'');
    html += `<div class='p-card'>
      <div class='split'><div><span class='muted'>ì¼ì‹œ</span> <span style='font-weight:700'>${t.dt.slice(11,16)}</span></div>
      <div><span class='muted'>ê³„ì¢Œ</span> <span>${acctStr}</span></div></div>
      <div class='muted' style='margin-top:6px'>ê¸ˆì•¡</div><div style='font-weight:700'>${sign}${fmt(t.amount)}</div>
      <div class='muted' style='margin-top:6px'>ë©”ëª¨</div><div>${t.memo||''}</div>
      <div class='actions' style='justify-content:flex-end'><button data-id='${t.id}' data-act='rev' class='danger'>ë˜ëŒë¦¬ê¸°</button></div>
    </div>`;
  });

  const v = varianceOn(date);
  if(v!==0){
    html += `<div class='muted' style='margin-top:8px'>ì¡°ì •(${v>0?'ì ˆì•½':'ì´ˆê³¼'}): <span style='color:${v>0?'var(--saving)':'var(--over)'};font-weight:700'>${v>0?'+':''}${fmt(v)}</span></div>`;
  }

  box.innerHTML = html;
  box.querySelectorAll('button[data-act="rev"]').forEach(btn=>{
    btn.onclick = ()=>{ const id = btn.dataset.id; const t = state.txns.find(x=>x.id===id); if(!t) return;
      if(!confirm('ì´ ì „í‘œë¥¼ ë˜ëŒë¦´ê¹Œìš”?')) return;
      state.txns.push({id:uid(), dt:nowLocalISO(), kind:'reversal', amount:t.amount, fromId:t.fromId||null, toId:t.toId||null, memo:'ì „í‘œ ë˜ëŒë¦¬ê¸°', partId:t.partId||null, reversalOf:t.id});
      save(); renderAll(); openDayDetail(date); };
  });
}
byId('btn-prev').onclick = ()=>{ calBase.setMonth(calBase.getMonth()-1); renderCalendar(); };
byId('btn-next').onclick = ()=>{ calBase.setMonth(calBase.getMonth()+1); renderCalendar(); };

/* ===== ë©”ëª¨ ===== */
function renderMemo(){
  const order = byId('memo-sort').value;
  const box = byId('memo-list'); box.innerHTML='';
  const arr = state.memos.slice();
  arr.sort((a,b)=> order==='desc' ? b.dt.localeCompare(a.dt) : a.dt.localeCompare(b.dt));
  arr.forEach(m=>{
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div class='split' style='margin-bottom:10px'>
        <div style='font-size:16px'>${m.text}</div><div class='muted'>${m.dt.replace('T',' ').slice(0,16)}</div>
      </div>
      <div class='flex' style='justify-content:flex-end;margin-top:8px;gap:8px'>
        <button data-id='${m.id}' data-act='edit'>ìˆ˜ì •</button>
        <button data-id='${m.id}' data-act='del' class='danger'>ì‚­ì œ</button>
      </div>`;
    box.appendChild(div);
  });
}
byId('btn-add-memo').onclick = ()=>{
  const t = prompt('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!t) return;
  state.memos.push({id:uid(), dt:nowLocalISO(), text:t});
  save(); renderMemo();
};
byId('memo-sort').onchange = ()=> renderMemo();
byId('memo-list').addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.id; const act = btn.dataset.act;
  if(act==='del'){
    if(confirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí• ê¹Œìš”?')){ state.memos = state.memos.filter(m=>m.id!==id); save(); renderMemo(); }
  }
  if(act==='edit'){
    const m = state.memos.find(x=>x.id===id); if(!m) return;
    const t = prompt('ë©”ëª¨ ìˆ˜ì •', m.text); if(t==null) return;
    m.text = t; m.dt = nowLocalISO(); save(); renderMemo();
  }
});

/* ===== ì„¤ì •/í…Œë§ˆ ===== */
function applyTheme(){ document.body.setAttribute('data-theme', state.settings.theme || 'dark'); }
byId('theme-select').onchange = (e)=>{ state.settings.theme = e.target.value; save(); applyTheme(); renderAll(); };
byId('btn-check-update').onclick = async ()=>{
  try{ const reg = await navigator.serviceWorker?.getRegistration?.(); await reg?.update?.(); alert('ì—…ë°ì´íŠ¸ í™•ì¸ ì™„ë£Œ! ìƒˆ ë²„ì „ì´ ìˆìœ¼ë©´ ì ì‹œ í›„ ìë™ ë°˜ì˜ë¼ìš”.'); }
  catch(e){ alert('í™•ì¸ ì‹¤íŒ¨: '+e.message); }
};
byId('btn-export').onclick = ()=>{
  try{ const raw = localStorage.getItem(LS_KEY)||'{}'; const blob = new Blob([raw],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pc_savings_backup_'+(new Date().toISOString().slice(0,10))+'.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),2000);
  }catch(e){ alert('ë°±ì—… ì‹¤íŒ¨: '+e.message); }
};
byId('btn-import').onclick = ()=> byId('file-import').click();
byId('file-import').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{ const t = await f.text(); const incoming = JSON.parse(t);
    if(!confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ë®ì–´ì“°ê³  ë³µì›í• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”)')) return;
    incoming.schema ??= APP_SCHEMA; incoming.accounts??=[]; incoming.parts??=[]; incoming.txns??=[]; incoming.memos??=[]; incoming.settings??={theme:'dark',targetMode:'parts',manualTarget:0};
    localStorage.setItem(LS_KEY, JSON.stringify(incoming)); state=incoming; renderAll(); alert('ë³µì› ì™„ë£Œ!');
  }catch(err){ alert('ë³µì› ì‹¤íŒ¨: '+err.message); }
  finally{ e.target.value=''; }
});
byId('btn-reset').onclick = ()=>{ if(confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')){ localStorage.removeItem(LS_KEY); location.reload(); } };

/* ===== ë„¤ë¹„ & ì´ˆê¸°í™” ===== */
const views = ['home','parts','funds','accounts-inline','transfer','cal','memo','settings'];
function show(v){
  views.forEach(x=>{ const el=byId('view-'+x); if(el) el.classList.toggle('hide', x!==v); });
  document.querySelectorAll('nav button').forEach(b=> b.classList.toggle('active', b.dataset.view===v));
  if(v==='home') renderRing();
  if(v==='parts') renderParts();
  if(v==='funds') { refreshAcctSelects(); renderFunds(); }
  if(v==='accounts-inline') renderAccounts();
  if(v==='transfer') { refreshAcctSelects(); }
  if(v==='cal') renderCalendar();
  if(v==='memo') renderMemo();
  if(v==='settings'){ byId('theme-select').value = state.settings.theme||'dark'; }
}
document.querySelectorAll('nav button').forEach(b=> b.onclick = ()=> show(b.dataset.view));
byId('btn-add-part').onclick = ()=>{ state.parts.push({id:uid(), name:'', price:0, qty:1, status:'planned', image:null, purchaseTxnIds:[], paid:0, actualPaid:0}); save(); renderParts(); renderRing(); };

/* ì…ë ¥ ì•ˆì •í™”: input/blur ëª¨ë‘ ìˆ˜ì‹  */
byId('parts-cards').addEventListener('input', onPartsChange);
byId('parts-cards').addEventListener('change', onPartsChange);
byId('parts-cards').addEventListener('click', onPartsClick);

function renderAll(){ applyTheme(); renderRing(); renderParts(); refreshAcctSelects(); renderFunds(); renderAccounts(); renderCalendar(); renderMemo(); }

/* ë¶€íŒ… */
try{ load(); renderAll(); console.log('App v1.1 â€” typing-stability fix'); }
catch(e){ alert('ì´ˆê¸°í™” ì˜¤ë¥˜: '+ e.message); console.error(e); }

/* SW ë“±ë¡ */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/savings_app/sw.js', { scope: '/savings_app/' })
      .then(r => console.log('SW registered', r.scope))
      .catch(e => console.error('SW register failed', e));
  });
}
</script>
</body>
</html>
